#' Select informative regions
#'
#' This function generates a list of informative regions to be used to estimate
#' the purity of a set of tumor samples.
#'
#' Informative regions are divided into \code{hyper} and \code{hypo} depending
#' on their level of methylation with respect to the average beta-score of
#' normal samples. Both sets will be used to compute purity.
#'
#' @param tumor_table A matrix of beta-values (percentage) from tumor samples.
#' @param auc A vector of AUC scores generated by \code{compute_AUC}.
#' @param max_sites Maximum number of regions to retrieve (half hyper-, half
#' hypo-methylated) (default = 20).
#' @param hyper_range A vector of length 2 with minimum lower and upper values
#' required to select hyper-methylated informative sites.
#' @param hypo_range A vector of length 2 with minimum lower and upper values
#' required to select hypo-methylated informative sites.
#' @return A named list of indexes of informative regions ("hyper-" and
#' "hypo-methylated").
#' @importFrom stats na.omit
#' @export
#' @examples
#' reduced_data <- reduce_to_regions(bs_toy_matrix, bs_toy_sites, cpg_islands[1:1000,])
#' auc_data <- compute_AUC(reduced_data[,1:10], reduced_data[,11:20])
#' info_regions <- select_informative_regions(reduced_data[,1:10], auc_data)
select_informative_regions <- function(tumor_table, auc, max_sites = 20,
  hyper_range = c(min = 40, max = 90), hypo_range = c(min = 10, max = 60)){
  message(sprintf("[%s] # Select informative regions #", Sys.time()))
  # check parameters
  diff_range_t <- diff(range(tumor_table, na.rm = TRUE))
  assertthat::assert_that(diff_range_t > 1, diff_range_t <= 100,
    msg="For computation efficiency convert tumor table to percentage values.")
  tumor_table <- as.matrix(tumor_table)
  tumor_table <- round(tumor_table)
  storage.mode(tumor_table) <- "integer"

  assertthat::assert_that(nrow(tumor_table) == length(auc))

  max_sites <- as.integer(max_sites)
  assertthat::assert_that(max_sites %% 2 == 0, msg="max_sites is not even")

  hyper_range <- as.numeric(hyper_range)
  hypo_range <- as.numeric(hypo_range)
  assertthat::assert_that(length(hyper_range) == 2)
  assertthat::assert_that(length(hypo_range) == 2)

  message(sprintf("Selected number of regions to retrieve: %i", max_sites))
  message(sprintf("Selected hyper-methylated regions range: %i-%i", hyper_range[1], hyper_range[2]))
  message(sprintf("Selected hyper-methylated regions range: %i-%i", hypo_range[1], hypo_range[2]))

  # minimum and maximum beta per site ----------------------------------------
  beta_high <- suppressWarnings(apply(tumor_table, 1, max, na.rm = TRUE))
  beta_low  <- suppressWarnings(apply(tumor_table, 1, min, na.rm = TRUE))
  hyper_idx <- which(beta_low < hyper_range[1] & beta_high > hyper_range[2] & auc > .80)
  hypo_idx  <- which(beta_low < hypo_range[1]  & beta_high > hypo_range[2]  & auc < .20)

  message(sprintf("[%s] Total hyper-methylated regions retrieved = %i", Sys.time(), length(hyper_idx)))
  message(sprintf("[%s] Total hypo-methylated regions retrieved = %i",  Sys.time(), length(hypo_idx)))

  ordered_hyper_idx <- hyper_idx[order(auc[hyper_idx], decreasing=TRUE)]
  ordered_hypo_idx  <- hypo_idx[order(auc[hypo_idx], decreasing=FALSE)]

  top_hyper_idx <- ordered_hyper_idx[seq(max_sites/2)]
  message(sprintf("[%s] Retrieved hyper-methylated regions = %i", Sys.time(), length(na.omit(top_hyper_idx))))

  top_hypo_idx <- ordered_hypo_idx[seq(max_sites/2)]
  message(sprintf("[%s] Retrieved hypo-methylated regions = %i", Sys.time(), length(na.omit(top_hypo_idx))))

  message(sprintf("[%s] Done", Sys.time()))
  return(list(hyper=top_hyper_idx, hypo=top_hypo_idx))
}
