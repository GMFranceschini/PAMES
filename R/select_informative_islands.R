#' Select informative CpG islands
#'
#' This function generates a list of informative CpG islands to be used to
#' estimate the purity of a set of tumor samples.
#'
#' Informative islands are divided into \code{hyper} and \code{hypo} depending
#' on their level of methylation with respect to the average beta-score of
#' normal samples. Both sets will be used to compute purity.
#'
#' @param tumor_table A matrix of beta-values (percentage) from tumor samples.
#' @param auc A vector of AUC scores generated by \code{compute_AUC}.
#' @param max_sites Maximum number of islands to retrieve (half hyper-, half
#' hypo-methylated) (default = 20).
#' @param hyper_range A vector of length 2 with minimum lower and upper values
#' required to select hyper-methylated informative sites.
#' @param hypo_range A vector of length 2 with minimum lower and upper values
#' required to select hypo-methylated informative sites.
#' @return A named list of indexes of informative islands ("hyper-" and
#' "hypo-methylated").
#' @importFrom stats na.omit
#' @export
#' @examples
#' reduced_data <- reduce_to_islands(round(bs_toy_matrix*100), bs_toy_indexes)
#' reduced_data <- round(reduced_data*100)
#' auc_data <- compute_AUC(reduced_data[,1:10], reduced_data[,11:20])
#' info_sites <- select_informative_islands(reduced_data[,1:10], auc_data)
select_informative_islands <- function(tumor_table, auc, max_sites = 20,
  hyper_range = c(min = 40, max = 90), hypo_range = c(min = 10, max = 60),
  tumor){
  # check parameters ---------------------------------------------------------
  assertthat::assert_that(max_sites %% 2 == 0, msg="max_sites is not even")

  if (!missing(tumor)){
    warning("'tumor' is deprecated. Use 'tumor_table' instead.")
    tumor_table <- tumor
  }
  tumor_table <- as.matrix(tumor_table)
  diff_range_t <- diff(range(tumor_table, na.rm = TRUE))
  assertthat::assert_that(diff_range_t > 1 && diff_range_t <= 100,
    msg=paste("For computation efficiency, convert tumor table",
      "to percentage values."))
  tumor_table <- round(tumor_table)
  storage.mode(tumor_table) <- "integer"

  message(sprintf("Number of sites: %i", max_sites))
  message(sprintf("Hyper-methylated sites range: %s", paste(hyper_range, collapse = " - ")))
  message(sprintf("Hypo-methylated sites range: %s",  paste(hypo_range, collapse = " - ")))

  # minimum and maximum beta per site ----------------------------------------
  beta_max <- suppressWarnings(apply(tumor_table, 1, max, na.rm=TRUE))
  beta_min <- suppressWarnings(apply(tumor_table, 1, min, na.rm=TRUE))
  hyper_idx <- which(beta_min < hyper_range[1] & beta_max > hyper_range[2] & auc > .80)
  hypo_idx  <- which(beta_min < hypo_range[1]  & beta_max > hypo_range[2]  & auc < .20)

  message(sprintf("[%s] Total hyper-methylated sites = %i", Sys.time(), length(hyper_idx)))
  message(sprintf("[%s] Total hypo-methylated sites = %i",  Sys.time(), length(hypo_idx)))

  ordered_hyper_idx <- hyper_idx[order(auc[hyper_idx], decreasing=TRUE)]
  ordered_hypo_idx  <- hypo_idx[order(auc[hypo_idx], decreasing=FALSE)]

  top_hyper_idx <- ordered_hyper_idx[seq(max_sites/2)]
  message(sprintf("[%s] Hyper-sites selection: %i", Sys.time(),
    length(na.omit(top_hyper_idx))))

  top_hypo_idx <- ordered_hypo_idx[seq(max_sites/2)]
  message(sprintf("[%s] Hypo-sites selection: %i", Sys.time(),
    length(na.omit(top_hypo_idx))))

  return(list(hyper=top_hyper_idx, hypo=top_hypo_idx))
}
