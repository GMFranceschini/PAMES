#' Select informative CpG islands
#'
#' Generate a list of informative CpG islands to be used to compute purity of
#' a set of tumor samples.
#'
#' Informative islands are divided into \code{hyper} and \code{hypo} depending on their level of
#' methylation with respect to the average beta value of normal samples.
#' Both sets will be used to compute purity.
#'
#' @param tumor a matrix of beta scores generated by BS technology.
#' Applied independently to each island (row).
#' @param max_sites maximum number of islands to retrieve (half hyper-,
#' half hypo-methylated) (default=20).
#' @return a list of indexes of informative islands (divided into two sets:
#' "hyper"- and "hypo"-methylated).
#' @examples
#' \dontrun{
#' info_sites <- select_informative_islands(mapped_bs_tumor_toy_data, auc)
#' }
#' @export
select_informative_islands <- function(tumor, auc, max_sites = 20){
    # check parameters ---------------------------------------------------------
    if (max_sites %% 2 != 0 & !is.integer(max_sites))
        stop("'max_sites' must be even")

    tumor   <- as.matrix(tumor)
    if (any(tumor < 0 | tumor > 1, na.rm=T))
        stop("Beta values in 'tumor' matrix must be decimal.")

    # minimum and maximum beta per site ----------------------------------------
    beta_max <- suppressWarnings(apply(tumor, 1, max, na.rm=T))
    beta_min <- suppressWarnings(apply(tumor, 1, min, na.rm=T))
    hyper_idx <- which(beta_min < .40 & beta_max > .90 & auc > .80)
    hypo_idx  <- which(beta_min < .10 & beta_max > .60 & auc < .20)

    message(sprintf("[%s] Total hyper-methylated sites = %i", Sys.time(), length(hyper_idx)))
    message(sprintf("[%s] Total hypo-methylated sites = %i",  Sys.time(), length(hypo_idx)))

    ordered_hyper_idx <- hyper_idx[order(auc[hyper_idx], decreasing=T)]
    ordered_hypo_idx  <- hypo_idx[order(auc[hypo_idx], decreasing=F)]

    top_hyper_idx <- ordered_hyper_idx[seq(max_sites/2)]
    message(sprintf("[%s] Hyper-sites selection: %i", Sys.time(),
                length(na.omit(top_hyper_idx))))

    top_hypo_idx <- ordered_hypo_idx[seq(max_sites/2)]
    message(sprintf("[%s] Hypo-sites selection: %i", Sys.time(),
                    length(na.omit(top_hypo_idx))))

    return(list(hyper=top_hyper_idx, hypo=top_hypo_idx))
}
